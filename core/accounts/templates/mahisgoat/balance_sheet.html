{% extends 'base.html' %}

{% block content %}
<style>
    main {
        max-width: 1200px !important;
        overflow: visible;
    }

    .table-container {
        overflow-x: auto;
        width: 100%;
        margin-bottom: 20px;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    .table {
        min-width: 1000px;
        width: 100%;
    }
</style>

<div class="container">
    <h1>{{ heading }}</h1>

    <!-- Filter Form -->
    <div class="section">
        <h3>Select Month and Year</h3>
        <form method="get">
            <div class="form-group">
                <label for="year">Year:</label>
                <select name="year" id="year" class="form-control">
                    {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="month">Month:</label>
                <select name="month" id="month" class="form-control">
                    {% for num, name in months %}
                        <option value="{{ num }}" {% if num == selected_month %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="btn">Load Records</button>
            <a href="{% url 'export_mahisgoat_balance' %}?year={{ selected_year }}&month={{ selected_month }}"
               class="btn"
               style="background-color: #27ae60;">
                Export to Excel
            </a>
        </form>
    </div>

    <!-- Balance Sheet Form -->
    <div class="section">
        <h3>Balance Sheet - {{ selected_month|date:"F" }} {{ selected_year }}</h3>
        <div class="table-container">
            <form id="balanceForm">
                {% csrf_token %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Bill</th>
                            <th>Commission</th>
                            <th>Extra</th>
                            <th>Britty</th>
                            <th>Income<br>(Commission + Extra + Britty)</th>
                            <th>Expenses</th>
                            <th>Profit/Loss<br>(Income - Expenses)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in forms %}
                        <tr>
                            <td>{{ form.date.value|date:"d M Y" }}</td>
                            <td>
                                {{ form.bill }}
                                {{ form.date.as_hidden }}
                            </td>
                            <td>{{ form.commission }}</td>
                            <td>{{ form.extra }}</td>
                            <td>{{ form.britty }}</td>
                            <td class="income-cell">0.00</td>
                            <td>{{ form.expenses }}</td>
                            <td class="profit-cell">0.00</td>
                        </tr>
                        {% endfor %}
                        <tr style="font-weight: bold; background-color: #f2f2f2;">
                            <td>Total</td>
                            <td id="total-bill">{{ totals.bill|default:"0.00" }}</td>
                            <td id="total-commission">{{ totals.commission|default:"0.00" }}</td>
                            <td id="total-extra">{{ totals.extra|default:"0.00" }}</td>
                            <td id="total-britty">{{ totals.britty|default:"0.00" }}</td>
                            <td id="total-income">{{ totals.income|default:"0.00" }}</td>
                            <td id="total-expenses">{{ totals.expenses|default:"0.00" }}</td>
                            <td id="total-profit">{{ totals.profit_loss|default:"0.00" }}</td>
                        </tr>
                    </tbody>
                </table>
            </form>
        </div>
        <button type="button" id="saveBtn" class="btn">Save Records</button>
    </div>

    <a href="{% url 'mahisgoat_main' %}" class="btn back">Back to MAHISGOAT</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.table-container table');
    const saveBtn = document.getElementById('saveBtn');

    function calculateRow(row) {
        const bill = parseFloat(row.querySelector('[name$="bill"]').value) || 0;
        const commission = parseFloat(row.querySelector('[name$="commission"]').value) || 0;
        const extra = parseFloat(row.querySelector('[name$="extra"]').value) || 0;
        const britty = parseFloat(row.querySelector('[name$="britty"]').value) || 0;
        const expenses = parseFloat(row.querySelector('[name$="expenses"]').value) || 0;

        const income = commission + extra + britty;
        const profit = income - expenses;

        row.querySelector('.income-cell').textContent = income.toFixed(2);
        row.querySelector('.profit-cell').textContent = profit.toFixed(2);

        const profitCell = row.querySelector('.profit-cell');
        if (profit > 0) {
            profitCell.style.backgroundColor = '#C6EFCE';
            profitCell.style.color = '#006100';
        } else if (profit < 0) {
            profitCell.style.backgroundColor = '#FFC7CE';
            profitCell.style.color = '#9C0006';
        } else {
            profitCell.style.backgroundColor = '';
            profitCell.style.color = '';
        }

        return { bill, commission, extra, britty, income, expenses, profit };
    }

    function calculateTotals() {
        const rows = table.querySelectorAll('tbody tr:not(:last-child)');
        let totals = {
            bill: 0, commission: 0, extra: 0, britty: 0, income: 0, expenses: 0, profit: 0
        };

        rows.forEach(row => {
            const values = calculateRow(row);
            for (let key in values) {
                totals[key] += values[key];
            }
        });

        document.getElementById('total-bill').textContent = totals.bill.toFixed(2);
        document.getElementById('total-commission').textContent = totals.commission.toFixed(2);
        document.getElementById('total-extra').textContent = totals.extra.toFixed(2);
        document.getElementById('total-britty').textContent = totals.britty.toFixed(2);
        document.getElementById('total-income').textContent = totals.income.toFixed(2);
        document.getElementById('total-expenses').textContent = totals.expenses.toFixed(2);
        document.getElementById('total-profit').textContent = totals.profit.toFixed(2);

        const totalProfitCell = document.getElementById('total-profit');
        if (totals.profit > 0) {
            totalProfitCell.style.backgroundColor = '#C6EFCE';
            totalProfitCell.style.color = '#006100';
        } else if (totals.profit < 0) {
            totalProfitCell.style.backgroundColor = '#FFC7CE';
            totalProfitCell.style.color = '#9C0006';
        } else {
            totalProfitCell.style.backgroundColor = '';
            totalProfitCell.style.color = '';
        }
    }

    calculateTotals();

    const inputs = table.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('input', calculateTotals);
    });

    saveBtn.addEventListener('click', function() {
        const rows = table.querySelectorAll('tbody tr:not(:last-child)');
        const savePromises = [];

        rows.forEach(row => {
            const formData = new FormData();
            formData.append('date', row.querySelector('[name$="date"]').value);
            formData.append('bill', row.querySelector('[name$="bill"]').value || '0');
            formData.append('commission', row.querySelector('[name$="commission"]').value || '0');
            formData.append('extra', row.querySelector('[name$="extra"]').value || '0');
            formData.append('britty', row.querySelector('[name$="britty"]').value || '0');
            formData.append('expenses', row.querySelector('[name$="expenses"]').value || '0');

            const promise = fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(response => response.json());

            savePromises.push(promise);
        });

        Promise.all(savePromises).then(results => {
            const allSuccess = results.every(r => r.status === 'success');
            if (allSuccess) {
                alert('All records saved successfully!');
            } else {
                const errors = results.filter(r => r.status === 'error');
                console.error('Errors saving records:', errors);
                alert(`${errors.length} records failed to save. Check console for details.`);
            }
        }).catch(error => {
            console.error('Error saving records:', error);
            alert('Error saving records. Please try again.');
        });
    });
});
</script>

<style>
.table td, .table th {
    text-align: center;
    vertical-align: middle;
    padding: 10px 15px;
    min-width: 110px;
}

input[type="number"] {
    width: 100px;
    text-align: center;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.income-cell, .profit-cell {
    font-weight: bold;
    padding: 10px 15px;
    min-width: 130px;
}

#saveBtn {
    margin-top: 20px;
    padding: 12px 25px;
    background-color: #2980b9;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    display: block;
    width: 100%;
    max-width: 200px;
    margin: 20px auto 0;
}

#saveBtn:hover {
    background-color: #1f6391;
}

.table th {
    background-color: #2c3e50;
    color: white;
    font-weight: 600;
}

tr[style*="background-color: #f2f2f2"] {
    background-color: #e9ecef !important;
    font-size: 16px;
}

@media (max-width: 1240px) {
    main {
        margin: 20px !important;
        padding: 15px !important;
    }
}

@media (max-width: 768px) {
    .table td, .table th {
        padding: 8px 10px;
        font-size: 14px;
    }

    input[type="number"] {
        width: 85px;
        padding: 6px;
    }
}
</style>
{% endblock %}


























































{% comment %} {% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1>{{ heading }}</h1>
    
    <!-- Filter Form -->
    <div class="section">
        <h3>Select Month and Year</h3>
        <form method="get">
            <div class="form-group">
                <label for="year">Year:</label>
                <select name="year" id="year" class="form-control">
                    {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="month">Month:</label>
                <select name="month" id="month" class="form-control">
                    {% for num, name in months %}
                        <option value="{{ num }}" {% if num == selected_month %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="btn">Load Records</button>
            <a href="{% url 'export_mahisgoat_balance' %}?year={{ selected_year }}&month={{ selected_month }}" 
               class="btn" 
               style="background-color: #27ae60;">
                Export to Excel
            </a>
        </form>
    </div>

    <!-- Balance Sheet Form -->
    <div class="section">
        <h3>Balance Sheet - {{ selected_month|date:"F" }} {{ selected_year }}</h3>
        <form id="balanceForm">
            {% csrf_token %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Bill</th>
                        <th>Commission</th>
                        <th>Extra</th>
                        <th>Britty</th>
                        <th>Income<br>(Commission + Extra + Britty)</th>
                        <th>Expenses</th>
                        <th>Profit/Loss<br>(Income - Expenses)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in forms %}
                    <tr>
                        <td>{{ form.date.value|date:"d M Y" }}</td>
                        <td>
                            {{ form.bill }}
                            {{ form.date.as_hidden }}
                        </td>
                        <td>{{ form.commission }}</td>
                        <td>{{ form.extra }}</td>
                        <td>{{ form.britty }}</td>
                        <td class="income-cell">0.00</td>
                        <td>{{ form.expenses }}</td>
                        <td class="profit-cell">0.00</td>
                    </tr>
                    {% endfor %}
                    <tr style="font-weight: bold; background-color: #f2f2f2;">
                        <td>Total</td>
                        <td id="total-bill">{{ totals.bill|default:"0.00" }}</td>
                        <td id="total-commission">{{ totals.commission|default:"0.00" }}</td>
                        <td id="total-extra">{{ totals.extra|default:"0.00" }}</td>
                        <td id="total-britty">{{ totals.britty|default:"0.00" }}</td>
                        <td id="total-income">{{ totals.income|default:"0.00" }}</td>
                        <td id="total-expenses">{{ totals.expenses|default:"0.00" }}</td>
                        <td id="total-profit">{{ totals.profit_loss|default:"0.00" }}</td>
                    </tr>
                </tbody>
            </table>
            <button type="button" id="saveBtn" class="btn">Save Records</button>
        </form>
    </div>

    <a href="{% url 'mahisgoat_main' %}" class="btn back">Back to MAHISGOAT</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('saveBtn');
    const table = document.querySelector('table');
    
    // Function to calculate row values
    function calculateRow(row) {
        const bill = parseFloat(row.querySelector('[name$="bill"]').value) || 0;
        const commission = parseFloat(row.querySelector('[name$="commission"]').value) || 0;
        const extra = parseFloat(row.querySelector('[name$="extra"]').value) || 0;
        const britty = parseFloat(row.querySelector('[name$="britty"]').value) || 0;
        const expenses = parseFloat(row.querySelector('[name$="expenses"]').value) || 0;
        
        const income = commission + extra + britty;
        const profit = income - expenses;
        
        row.querySelector('.income-cell').textContent = income.toFixed(2);
        row.querySelector('.profit-cell').textContent = profit.toFixed(2);
        
        // Set profit cell color
        if (profit > 0) {
            row.querySelector('.profit-cell').style.backgroundColor = '#C6EFCE';
            row.querySelector('.profit-cell').style.color = '#006100';
        } else if (profit < 0) {
            row.querySelector('.profit-cell').style.backgroundColor = '#FFC7CE';
            row.querySelector('.profit-cell').style.color = '#9C0006';
        } else {
            row.querySelector('.profit-cell').style.backgroundColor = '';
            row.querySelector('.profit-cell').style.color = '';
        }
        
        return { bill, commission, extra, britty, income, expenses, profit };
    }
    
    // Function to calculate totals
    function calculateTotals() {
        let totals = {
            bill: 0,
            commission: 0,
            extra: 0,
            britty: 0,
            income: 0,
            expenses: 0,
            profit: 0
        };
        
        const rows = table.querySelectorAll('tbody tr:not(:last-child)');
        rows.forEach(row => {
            const values = calculateRow(row);
            for (const key in values) {
                totals[key] += values[key];
            }
        });
        
        // Update totals row
        document.getElementById('total-bill').textContent = totals.bill.toFixed(2);
        document.getElementById('total-commission').textContent = totals.commission.toFixed(2);
        document.getElementById('total-extra').textContent = totals.extra.toFixed(2);
        document.getElementById('total-britty').textContent = totals.britty.toFixed(2);
        document.getElementById('total-income').textContent = totals.income.toFixed(2);
        document.getElementById('total-expenses').textContent = totals.expenses.toFixed(2);
        document.getElementById('total-profit').textContent = totals.profit.toFixed(2);
        
        // Set total profit color
        const totalProfitCell = document.getElementById('total-profit');
        if (totals.profit > 0) {
            totalProfitCell.style.backgroundColor = '#C6EFCE';
            totalProfitCell.style.color = '#006100';
        } else if (totals.profit < 0) {
            totalProfitCell.style.backgroundColor = '#FFC7CE';
            totalProfitCell.style.color = '#9C0006';
        } else {
            totalProfitCell.style.backgroundColor = '';
            totalProfitCell.style.color = '';
        }
    }
    
    // Calculate initial values
    calculateTotals();
    
    // Add event listeners to all input fields
    const inputs = table.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('input', calculateTotals);
    });
    
    // Save button handler
    saveBtn.addEventListener('click', function() {
        const rows = table.querySelectorAll('tbody tr:not(:last-child)');
        const savePromises = [];
        
        rows.forEach(row => {
            const formData = new FormData();
            const dateInput = row.querySelector('[name$="date"]');
            const billInput = row.querySelector('[name$="bill"]');
            const commissionInput = row.querySelector('[name$="commission"]');
            const extraInput = row.querySelector('[name$="extra"]');
            const brittyInput = row.querySelector('[name$="britty"]');
            const expensesInput = row.querySelector('[name$="expenses"]');
            
            // Add values to form data
            formData.append('date', dateInput.value);
            formData.append('bill', billInput.value || '0');
            formData.append('commission', commissionInput.value || '0');
            formData.append('extra', extraInput.value || '0');
            formData.append('britty', brittyInput.value || '0');
            formData.append('expenses', expensesInput.value || '0');
            
            // Send AJAX request
            const promise = fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json());
            
            savePromises.push(promise);
        });
        
        // Handle all save operations
        Promise.all(savePromises)
            .then(results => {
                const allSuccess = results.every(r => r.status === 'success');
                if (allSuccess) {
                    alert('All records saved successfully!');
                } else {
                    const errors = results.filter(r => r.status === 'error');
                    console.error('Errors saving records:', errors);
                    alert(`${errors.length} records failed to save. Check console for details.`);
                }
            })
            .catch(error => {
                console.error('Error saving records:', error);
                alert('Error saving records. Please try again.');
            });
    });
});
</script>

<style>
.table td, .table th {
    text-align: center;
    vertical-align: middle;
}

input[type="number"] {
    width: 100px;
    text-align: center;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.income-cell, .profit-cell {
    font-weight: bold;
    padding: 10px;
}

.form-group {
    margin-bottom: 0;
}

#saveBtn {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #2980b9;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#saveBtn:hover {
    background-color: #1f6391;
}
</style>
{% endblock %} {% endcomment %}


















































































{% comment %} {% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1>{{ heading }}</h1>
    <!-- Add your specific content here later -->
    <a href="{% url 'mahisgoat_main' %}" class="btn back">Back to MAHISGOAT</a>
</div>
{% endblock %} {% endcomment %}